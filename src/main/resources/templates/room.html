<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Video Room</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.0/sockjs.min.js"></script>
</head>
<body class="bg-gray-100">
<div class="container mx-auto p-4">
    <div class="bg-white rounded-lg shadow-lg p-6">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold">Room: <span th:text="${roomId}" class="text-blue-600"></span></h2>
            <button onclick="copyRoomId()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                <i class="fas fa-copy mr-2"></i>Copy Room ID
            </button>
        </div>

        <div id="errorMessage"
             class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4"></div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="relative">
                <video id="localVideo" autoplay playsinline muted class="w-full rounded-lg bg-black"></video>
                <p class="absolute top-2 left-2 bg-black bg-opacity-50 text-white px-2 py-1 rounded">You</p>
            </div>
            <div class="relative">
                <video id="remoteVideo" autoplay playsinline class="w-full rounded-lg bg-black"></video>
                <p class="absolute top-2 left-2 bg-black bg-opacity-50 text-white px-2 py-1 rounded">Remote User</p>
                <div id="waitingMessage"
                     class="absolute inset-0 flex items-center justify-center text-white bg-black bg-opacity-50">
                    Waiting for someone to join...
                </div>
            </div>
        </div>

        <div class="flex justify-center space-x-4 mt-6">
            <button onclick="toggleAudio()" id="audioBtn"
                    class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-full">
                <i class="fas fa-microphone"></i>
            </button>
            <button onclick="toggleVideo()" id="videoBtn"
                    class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-full">
                <i class="fas fa-video"></i>
            </button>
            <button onclick="endCall()" class="bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-full">
                <i class="fas fa-phone-slash"></i>
            </button>
        </div>
    </div>
</div>
<script th:inline="javascript">
    const roomId = [[${roomId}]];
    let pc;
    let localStream;
    let ws;
    let isAudioMuted = false;
    let isVideoOff = false;

    function showError(message) {
        const errorDiv = document.getElementById('errorMessage');
        errorDiv.textContent = message;
        errorDiv.classList.remove('hidden');
        setTimeout(() => errorDiv.classList.add('hidden'), 5000);
    }

    async function initializeWebSocket() {
        try {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/signal`;
            ws = new SockJS(wsUrl);

            ws.onopen = () => {
                console.log('WebSocket Connected');
                ws.send(JSON.stringify({type: 'join', roomId: roomId}));
                initializePeerConnection();
            };

                    ws.onmessage = async (event) => {
                        const message = JSON.parse(event.data);
                        try {
                            switch (message.type) {
                                case 'offer':
                                    await handleOffer(message);
                                    break;
                                case 'answer':
                                    await handleAnswer(message);
                                    break;
                                case 'candidate':
                                    await handleCandidate(message);
                                    break;
                                case 'user-joined':
                                    document.getElementById('waitingMessage').style.display = 'none';
                                    break;
                                case 'user-left':
                                    document.getElementById('waitingMessage').style.display = 'flex';
                                    document.getElementById('waitingMessage').textContent = 'Remote user left. Waiting for someone to join...';
                                    break;
                                case 'error':
                                    showError(message.message);
                                    break;
                            }
                        } catch (error) {
                            console.error('Error handling message:', error);
                            showError('Error processing video call data');
                        }
                     };

                ws.onerror = (error) => {
                    console.error('WebSocket Error:', error);
                    showError('Connection error occurred');
                };

                ws.onclose = () => {
                    console.log('WebSocket Closed');
                    showError('Connection closed. Please refresh the page.');
                };

            } catch (error) {
                console.error('WebSocket initialization error:', error);
                showError('Failed to establish connection');
            }
        }
        
            async function handleOffer(message) {
                await pc.setRemoteDescription(new RTCSessionDescription(message.offer));
                const answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);
                ws.send(JSON.stringify({type: 'answer', answer: answer, roomId: roomId}));
            }

            async function handleAnswer(message) {
                await pc.setRemoteDescription(new RTCSessionDescription(message.answer));
            }

            async function handleCandidate(message) {
                if (message.candidate) {
                    try {
                        await pc.addIceCandidate(new RTCIceCandidate(message.candidate));
                    } catch (error) {
                        console.error('Error adding ICE candidate:', error);
                    }
                }
            }

            function handleWebSocketError() {
                if (reconnectAttempts < maxReconnectAttempts) {
                    reconnectAttempts++;
                    const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), 10000); // Exponential backoff with max 10s
                    console.log(`Attempting to reconnect in ${delay / 1000}s... (${reconnectAttempts}/${maxReconnectAttempts})`);

                    setTimeout(() => {
                        initializeWebSocket();
                    }, delay);
                } else {
                    alert('Connection failed. Please check your internet connection and refresh the page.');
                }
            }

            function initializePeerConnection() {
                if (pc) {
                    pc.close();
                }

                pc = new RTCPeerConnection({
                    iceServers: [
                        {urls: 'stun:stun.l.google.com:19302'},
                        {urls: 'stun:stun1.l.google.com:19302'},
                        {
                            urls: 'turn:numb.viagenie.ca',
                            username: 'webrtc@live.com',
                            credential: 'muazkh'
                        }
                    ]
                });

                pc.onicecandidate = event => {
                    if (event.candidate && ws.readyState === WebSocket.OPEN) {
                        ws.send(JSON.stringify({
                            type: 'candidate',
                            candidate: event.candidate,
                            roomId: roomId
                        }));
                    }
                };

                pc.ontrack = event => {
                    document.getElementById('remoteVideo').srcObject = event.streams[0];
                    document.getElementById('waitingMessage').style.display = 'none';
                };

                pc.oniceconnectionstatechange = () => {
                    if (pc.iceConnectionState === 'disconnected' || pc.iceConnectionState === 'failed') {
                        document.getElementById('waitingMessage').style.display = 'flex';
                        document.getElementById('waitingMessage').textContent = 'Connection lost. Attempting to reconnect...';
                        handleConnectionFailure();
                    }
                };

                if (localStream) {
                    localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
                }
            }

            async function initializeMediaStream() {
                try {
                    localStream = await navigator.mediaDevices.getUserMedia({
                        video: {
                            width: {ideal: 1280},
                            height: {ideal: 720}
                        },
                        audio: true
                    });
                    document.getElementById('localVideo').srcObject = localStream;

                    if (pc) {
                        localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
                    }

                    await createOffer();
                } catch (error) {
                    console.error('Error accessing media devices:', error);
                    alert('Failed to access camera/microphone. Please check permissions and ensure no other application is using them.');
                }
            }

            async function createOffer() {
                if (!pc || ws.readyState !== WebSocket.OPEN) return;

                try {
                    const offer = await pc.createOffer();
                    await pc.setLocalDescription(offer);
                    ws.send(JSON.stringify({
                        type: 'offer',
                        offer: pc.localDescription,
                        roomId: roomId
                    }));
                } catch (error) {
                    console.error('Error creating offer:', error);
                    alert('Failed to establish connection. Please refresh the page.');
                }
            }

            function toggleAudio() {
                if (!localStream) return;

                const audioTrack = localStream.getAudioTracks()[0];
                if (audioTrack) {
                    isAudioMuted = !isAudioMuted;
                    audioTrack.enabled = !isAudioMuted;
                    document.getElementById('audioBtn').innerHTML =
                        isAudioMuted ? '<i class="fas fa-microphone-slash"></i>' : '<i class="fas fa-microphone"></i>';
                    document.getElementById('audioBtn').classList.toggle('bg-red-500');
                }
            }

            function toggleVideo() {
                if (!localStream) return;

                const videoTrack = localStream.getVideoTracks()[0];
                if (videoTrack) {
                    isVideoOff = !isVideoOff;
                    videoTrack.enabled = !isVideoOff;
                    document.getElementById('videoBtn').innerHTML =
                        isVideoOff ? '<i class="fas fa-video-slash"></i>' : '<i class="fas fa-video"></i>';
                    document.getElementById('videoBtn').classList.toggle('bg-red-500');
                }
            }

            function copyRoomId() {
                navigator.clipboard.writeText(roomId)
                    .then(() => alert('Room ID copied to clipboard!'))
                    .catch(err => console.error('Failed to copy room ID:', err));
            }

            function endCall() {
                if (localStream) {
                    localStream.getTracks().forEach(track => track.stop());
                }
                if (pc) pc.close();
                if (ws) ws.close();
                window.location.href = "/";
            }

            async function handleConnectionFailure() {
                if (pc) pc.close();
                await initializePeerConnection();
                await createOffer();
            }

            window.onload = async () => {
                try {
                    await initializeWebSocket();
                    await initializeMediaStream();
                } catch (error) {
                    console.error('Initialization error:', error);
                    showError('Failed to initialize video call');
                }
            };

            window.onbeforeunload = () => {
                endCall();
            }
</script>

</body>
</html>