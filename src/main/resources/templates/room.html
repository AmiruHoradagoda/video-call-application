<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Video Room</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.0/sockjs.min.js"></script>
</head>
<body class="bg-gray-100">
<!-- HTML structure remains the same -->

<script th:inline="javascript">
    const roomId = [[${roomId}]];
    let pc;
    let localStream;
    let ws;
    let isAudioMuted = false;
    let isVideoOff = false;
    let reconnectAttempts = 0;
    const maxReconnectAttempts = 5;

    function showError(message) {
        const errorDiv = document.getElementById('errorMessage');
        errorDiv.textContent = message;
        errorDiv.classList.remove('hidden');
        setTimeout(() => errorDiv.classList.add('hidden'), 5000);
    }

    async function initializeWebSocket() {
        try {
            const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const host = window.location.host;
            const wsUrl = `${wsProtocol}//${host}/signal`;
            console.log('Connecting to WebSocket at:', wsUrl);

            ws = new SockJS(wsUrl, null, {
                transports: ['websocket', 'xhr-streaming', 'xhr-polling'],
                timeout: 15000,
                debug: true
            });

            ws.onopen = () => {
                console.log('WebSocket Connected');
                reconnectAttempts = 0;
                ws.send(JSON.stringify({type: 'join', roomId: roomId}));
                initializePeerConnection();
            };

            ws.onmessage = async (event) => {
                console.log('Received message:', event.data);
                const message = JSON.parse(event.data);
                try {
                    switch (message.type) {
                        case 'offer':
                            await handleOffer(message);
                            break;
                        case 'answer':
                            await handleAnswer(message);
                            break;
                        case 'candidate':
                            await handleCandidate(message);
                            break;
                        case 'user-joined':
                            document.getElementById('waitingMessage').style.display = 'none';
                            break;
                        case 'user-left':
                            document.getElementById('waitingMessage').style.display = 'flex';
                            document.getElementById('waitingMessage').textContent = 'Remote user left. Waiting for someone to join...';
                            break;
                        case 'error':
                            showError(message.message);
                            break;
                    }
                } catch (error) {
                    console.error('Error handling message:', error);
                    showError('Error processing video call data');
                }
            };

            ws.onerror = (error) => {
                console.error('WebSocket Error:', error);
                handleWebSocketError();
            };

            ws.onclose = (event) => {
                console.log('WebSocket Closed:', event.code, event.reason);
                handleWebSocketError();
            };

        } catch (error) {
            console.error('WebSocket initialization error:', error);
            handleWebSocketError();
        }
    }

    function handleWebSocketError() {
        if (reconnectAttempts < maxReconnectAttempts) {
            reconnectAttempts++;
            const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), 10000);
            console.log(`Attempting to reconnect in ${delay/1000}s... (${reconnectAttempts}/${maxReconnectAttempts})`);

            setTimeout(() => {
                initializeWebSocket();
            }, delay);
        } else {
            showError('Connection failed. Please refresh the page.');
        }
    }
    async function initializeMediaStream() {
        try {
            localStream = await navigator.mediaDevices.getUserMedia({
                video: {
                    width: { ideal: 1280 },
                    height: { ideal: 720 },
                    facingMode: 'user'
                },
                audio: {
                    echoCancellation: true,
                    noiseSuppression: true,
                    autoGainControl: true
                }
            });

            document.getElementById('localVideo').srcObject = localStream;

            if (pc) {
                localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
            }

            await createOffer();
        } catch (error) {
            console.error('Error accessing media devices:', error);
            showError('Failed to access camera/microphone. Please check permissions.');
        }
    }

    async function handleOffer(message) {
        try {
            await pc.setRemoteDescription(new RTCSessionDescription(message.offer));
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            ws.send(JSON.stringify({
                type: 'answer',
                answer: answer,
                roomId: roomId
            }));
        } catch (error) {
            console.error('Error handling offer:', error);
            showError('Failed to process incoming call');
        }
    }

    async function handleAnswer(message) {
        try {
            await pc.setRemoteDescription(new RTCSessionDescription(message.answer));
        } catch (error) {
            console.error('Error handling answer:', error);
            showError('Failed to establish connection');
        }
    }

    async function handleCandidate(message) {
        if (message.candidate) {
            try {
                await pc.addIceCandidate(new RTCIceCandidate(message.candidate));
            } catch (error) {
                console.error('Error adding ICE candidate:', error);
            }
        }
    }

    async function createOffer() {
        if (!pc || !ws || ws.readyState !== SockJS.OPEN) return;

        try {
            const offer = await pc.createOffer({
                offerToReceiveAudio: true,
                offerToReceiveVideo: true
            });
            await pc.setLocalDescription(offer);
            ws.send(JSON.stringify({
                type: 'offer',
                offer: pc.localDescription,
                roomId: roomId
            }));
        } catch (error) {
            console.error('Error creating offer:', error);
            showError('Failed to initiate call');
        }
    }

    async function handleConnectionFailure() {
        if (pc) {
            pc.close();
        }
        await initializePeerConnection();
        await createOffer();
    }

    function toggleAudio() {
        if (!localStream) return;

        const audioTrack = localStream.getAudioTracks()[0];
        if (audioTrack) {
            isAudioMuted = !isAudioMuted;
            audioTrack.enabled = !isAudioMuted;
            const audioBtn = document.getElementById('audioBtn');
            audioBtn.innerHTML = isAudioMuted ?
                '<i class="fas fa-microphone-slash"></i>' :
                '<i class="fas fa-microphone"></i>';
            audioBtn.classList.toggle('bg-red-500');
            audioBtn.classList.toggle('bg-gray-500');
        }
    }

    function toggleVideo() {
        if (!localStream) return;

        const videoTrack = localStream.getVideoTracks()[0];
        if (videoTrack) {
            isVideoOff = !isVideoOff;
            videoTrack.enabled = !isVideoOff;
            const videoBtn = document.getElementById('videoBtn');
            videoBtn.innerHTML = isVideoOff ?
                '<i class="fas fa-video-slash"></i>' :
                '<i class="fas fa-video"></i>';
            videoBtn.classList.toggle('bg-red-500');
            videoBtn.classList.toggle('bg-gray-500');
        }
    }

    function copyRoomId() {
        navigator.clipboard.writeText(roomId)
            .then(() => {
                const copyBtn = document.querySelector('button[onclick="copyRoomId()"]');
                const originalText = copyBtn.innerHTML;
                copyBtn.innerHTML = '<i class="fas fa-check mr-2"></i>Copied!';
                setTimeout(() => {
                    copyBtn.innerHTML = originalText;
                }, 2000);
            })
            .catch(err => {
                console.error('Failed to copy room ID:', err);
                showError('Failed to copy room ID');
            });
    }

    function endCall() {
        if (localStream) {
            localStream.getTracks().forEach(track => track.stop());
        }
        if (pc) {
            pc.close();
        }
        if (ws) {
            ws.close();
        }
        window.location.href = "/";
    }

    window.onload = async () => {
        try {
            await initializeWebSocket();
            await initializeMediaStream();
        } catch (error) {
            console.error('Initialization error:', error);
            showError('Failed to initialize video call');
        }
    };

    window.onbeforeunload = () => {
        endCall();
    };
</script>
</body>
</html>