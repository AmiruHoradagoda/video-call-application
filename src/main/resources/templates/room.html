<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Video Room</title>
</head>
<body>
<h2>Room: <span th:text="${roomId}"></span></h2>
<video id="localVideo" autoplay playsinline></video>
<video id="remoteVideo" autoplay playsinline></video>

<script th:inline="javascript">
    const roomId = [[${roomId}]];
    const ws = new WebSocket('ws://localhost:8080/signal');
    let pc = new RTCPeerConnection();

    // Get local video stream
    navigator.mediaDevices.getUserMedia({video: true, audio: true})
        .then(stream => {
            document.getElementById('localVideo').srcObject = stream;
            stream.getTracks().forEach(track => pc.addTrack(track, stream));
        });

    // WebSocket signaling
    ws.onopen = () => {
        ws.send(JSON.stringify({type: 'join', roomId: roomId}));
    };

    ws.onmessage = async (event) => {
        const message = JSON.parse(event.data);
        if (message.type === 'offer') {
            await pc.setRemoteDescription(new RTCSessionDescription(message.offer));
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            ws.send(JSON.stringify({
                type: 'answer',
                answer: answer,
                roomId: roomId
            }));
        } else if (message.type === 'answer') {
            await pc.setRemoteDescription(new RTCSessionDescription(message.answer));
        } else if (message.type === 'candidate') {
            await pc.addIceCandidate(new RTCIceCandidate(message.candidate));
        }
    };

    // Handle ICE candidates
    pc.onicecandidate = event => {
        if (event.candidate) {
            ws.send(JSON.stringify({
                type: 'candidate',
                candidate: event.candidate,
                roomId: roomId
            }));
        }
    };

    // Display remote video
    pc.ontrack = event => {
        document.getElementById('remoteVideo').srcObject = event.streams[0];
    };

    // Create offer when joining room
    pc.createOffer()
        .then(offer => pc.setLocalDescription(offer))
        .then(() => {
            ws.send(JSON.stringify({
                type: 'offer',
                offer: pc.localDescription,
                roomId: roomId
            }));
        });
</script>
</body>
</html>